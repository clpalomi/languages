<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Signing you in…</title>
  <style> body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding:24px;} </style>

  <script type="module">
  import { supabase } from './js/client.js';
  import { baseURL } from './js/utils.js';

  const params = new URLSearchParams(location.search);
  const next = params.get('next') || (baseURL + 'app.html');

  const go = () => {
    // (Optional) clean the callback URL right before leaving, if you ever want:
    // history.replaceState({}, '', location.pathname + location.search);
    location.replace(next);
  };

  // 1) First let Supabase read the tokens (DON'T clear the hash yet)
  console.log('callback loaded', location.href);
  const { data: { session } } = await supabase.auth.getSession();
  console.log('session immediately?', !!session);
  if (session?.user) {
    go();
  } else {
    // 2) Catch the async SIGNED_IN event
    supabase.auth.onAuthStateChange((event) => {
      if (event === 'SIGNED_IN') go();
    });
    // 3) Small fallback in case the event is missed (rare)
    setTimeout(async () => {
      const { data: { session: s } } = await supabase.auth.getSession();
      if (s?.user) go();
    }, 800);
  }
</script>


  
</head>
<body>
  <p>Signing you in…</p>
</body>
</html>
